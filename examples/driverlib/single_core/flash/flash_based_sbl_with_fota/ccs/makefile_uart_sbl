export C29SDK_ROOT?=$(abspath ../../../../../..)
include $(C29SDK_ROOT)/imports.mak

# To build a complete flash SBL project, use top-level flash_based_uart_sbl.mk instead
# This makefile flash SBL subproject requires its application firmware (led_blinky) to be built first

# For BANKMODE1_NONSECURE config, use "Make -f makefile_uart_sbl all BANKMODE=1 APP=NONSECURE"
# For BANKMODE3_NONSECURE config, use "Make -f makefile_uart_sbl all BANKMODE=3 APP=NONSECURE"
# For BANKMODE1_SECURE_CP config, use "Make -f makefile_uart_sbl all BANKMODE=1 APP=SECURE"
# For BANKMODE3_SECURE_CP config, use "Make -f makefile_uart_sbl all BANKMODE=3 APP=SECURE"

Target = flash_based_uart_sbl_with_fota
LFLAGS_common = -Wl,--entry_point="code_start",--stack_size=0x1000,--heap_size=0x400,-i"$(CGT29X_PATH)\lib",--rom_model,--reread_libs,--diag_suppress=10325-D,--diag_suppress=10063-D ## Override default linker flag due to insufficient stack size
PROFILE = release

# Custom profile configuration
CFLAGS_release = -O1 -ffast-math
# LFLAGS += -Wl,--copy_compression=lzss # Disable LZSS compression due to CCS20.2 debug errors

CFLAGS := $(CFLAGS_$(PROFILE)) $(CFLAGS_common) -D_FLASH
LFLAGS := $(LFLAGS_common) 
INCLUDES_LIBS := $(addprefix -Wl$(comma)-i, $(dir $(LIBRARIES_common) $(INCLUDES_PATH_common))) $(addprefix -Wl$(comma)-l, $(notdir $(LIBRARIES_common)))
INCLUDES_PATH := $(INCLUDES_common) $(INCLUDES_syscfg)
INCLUDES = $(addprefix -I , $(INCLUDES_PATH) $(INCLUDES_PATH_common))
FILES_PATH = $(FILES_PATH_common)
LIBS = $(LIB) $(LIBRARIES_common)
OBJS = $(CMD_SRCS)

SYSCFG_FILE ?= ../uart/flash_based_uart_sbl.syscfg

# Setting Bankmode 1 vs 3
ifeq ($(BANKMODE),3)
CMD_SRCS ?= ../cmd/f29h85x_bankmode3_flash_sbl_cpu1.cmd
else
CMD_SRCS ?= ../cmd/f29h85x_bankmode1_flash_sbl_cpu1.cmd
endif

APP_FLAG ?= -DNONSECURE

# Setting SECURE/CP configuration
ifeq ($(APP),SECURE)
APP_FLAG += -DSECURE_CP
DEVICE_TYPE = HS
DEBUG_TIFS = yes
ENC_SBL_ENABLED = no
endif

# Certificate generation parameters
ifeq ($(DEVICE_TYPE),HS)
DEBUG_COMMAND=
IMG_INTEG_CMD=--img_integ yes
else
DEBUG_COMMAND=--debug DBG_SOC_DEFAULT
IMG_INTEG_CMD=--img_integ no
endif
ifeq ($(DEBUG_TIFS), yes)
DEBUG_COMMAND=
else
DEBUG_COMMAND=--debug $(DEBUG_OPTION)
endif
ifeq ($(ENC_SBL_ENABLED), yes)
ENC_SBL_OPTION=--sbl-enc --enc-key $(C29SDK_ROOT)/tools/boot/signing/mcu_custMek.key --kd-salt $(C29SDK_ROOT)/tools/boot/signing/kd_salt.txt
else
ENC_SBL_OPTION=
endif

# Path to recognize all C-source files exhaustively
FILES_PATH_common = \
	.. \
	../uart/ \

# Addintional include path (-i) for the compiler
INCLUDES_PATH_common = \
	.. \
	../uart/ \
	${C29SDK_ROOT}/source \
	${C29SDK_ROOT}/source/flash_api/include/FlashAPI \
	${C29SDK_ROOT}/source/flash_api/include/Constants \

# Addintional library path (-l) for the compiler
LIBRARIES_common = \
	"${C29SDK_ROOT}/source/flash_api/lib/F29H85x_NWFlashAPI_v21.00.00.00.lib" \
	"${C29SDK_ROOT}/source/driverlib/ccs/driverlib_release.lib" \
	"${C29SDK_ROOT}/source/kernel/nortos/ccs/dpl_nortos.lib" \
	"${C29SDK_ROOT}/source/security/ccs/security_drivers.lib" \

OBJDIR := $(abspath)

build-syscfg: $(SYSCFG_FILE)
	@echo 'Building file: "$<"'
	@echo 'Invoking: SysConfig'
	$(SYSCFG) -s "$(C29SDK_ROOT)/.metadata/sdk.json" --script "$(SYSCFG_FILE)" -o "syscfg" --compiler ticlang
	@echo 'Finished building: "$<"'
	@echo ' '

syscfg/board.c: build-syscfg $(SYSCFG_FILE)
syscfg/board.h: build-syscfg
syscfg/board.cmd.genlibs: build-syscfg
syscfg/pinmux.csv: build-syscfg

"./syscfg/board.o": ./syscfg/board.c
	@echo 'Building file: "$<"'
	@echo 'Invoking: C2000 Compiler'
	$(COMPILER) $(CFLAGS) $(INCLUDES) -MMD -MP -MF"syscfg/$(basename $(<F)).d" -MT"$(@)" -o"$@" "$<"
	@echo 'Finished building: "$<"'
	@echo ' '

"./syscfg/device.o": ./syscfg/device.c
	@echo 'Building file: "$<"'
	@echo 'Invoking: C2000 Compiler'
	$(COMPILER) $(CFLAGS) $(INCLUDES) -MMD -MP -MF"syscfg/$(basename $(<F)).d" -MT"$(@)" -o"$@" "$<"
	@echo 'Finished building: "$<"'
	@echo ' '

"./syscfg/ti_drivers_config.o": ./syscfg/ti_drivers_config.c
	@echo 'Building file: "$<"'
	@echo 'Invoking: C2000 Compiler'
	$(COMPILER) $(CFLAGS) $(INCLUDES) -MMD -MP -MF"syscfg/$(basename $(<F)).d" -MT"$(@)" -o"$@" "$<"
	@echo 'Finished building: "$<"'
	@echo ' '

"./syscfg/ti_dpl_config.o": ./syscfg/ti_dpl_config.c
	@echo 'Building file: "$<"'
	@echo 'Invoking: C2000 Compiler'
	$(COMPILER) $(CFLAGS) $(INCLUDES) -MMD -MP -MF"syscfg/$(basename $(<F)).d" -MT"$(@)" -o"$@" "$<"
	@echo 'Finished building: "$<"'
	@echo ' '

OBJS  += \
"./syscfg/board.o" \
"./syscfg/device.o" \
"./syscfg/ti_drivers_config.o"  \
"./syscfg/ti_dpl_config.o"      \
#$(wildcard ./syscfg/*.o)

syscfg-gui:
	$(SYSCFG_ROOT)/nw/nw $(SYSCFG_ROOT) --product $(C29SDK_ROOT)/.metadata/sdk.json --output generated/ $(SYSCFG_FILE)


C_SRCS += $(foreach dir, $(FILES_PATH), $(wildcard $(dir)/*.c))
ASM_SRCS = $(foreach dir, $(FILES_PATH), $(wildcard $(dir)/*.asm))
vpath %.c $(FILES_PATH)
vpath %.asm $(FILES_PATH)

OBJS += $(notdir $(C_SRCS:%.c=%.o))
OBJS += $(notdir $(ASM_SRCS:%.asm=%.o))

CFLAGS		+= $(APP_FLAG)
CFLAGS      += -DSOC_F29H85X

OBJS_CLEAN = $(filter-out $(CMD_SRCS), $(OBJS))

$(OBJDIR)/%.o %.o: %.c
	@echo 'Building file: $<'
	@echo 'Invoking: Compiler'
	$(COMPILER) $(CFLAGS) -MMD -MP $(INCLUDES) "$<"
	@echo 'Finished building: $<'
	@echo ' '

$(OBJDIR)/%.o %.o: %.asm
	@echo 'Building file: $<'
	@echo 'Invoking: Compiler'
	$(COMPILER) $(CFLAGS) $(INCLUDES) "$<"
	@echo 'Finished building: $<'
	@echo ' '

# All Target
all: $(Target).out
$(Target).out: $(OBJS)
	@echo 'Building target: $@'
	@echo 'Invoking: C2000 Linker'
	$(LINKER) $(CFLAGS_$(PROFILE)) $(INCLUDE_LIBS) -Wl,-m=$(Target).map $(LFLAGS) -o "$@" $(OBJS) $(LIBS)
	@echo 'Finished building target: $@'
	@echo 'Post build steps'
	@echo 'Creating bin file'
	$(CG_TOOL_OBJCOPY) --update-section cpu1app=../../cpu1_firmware.bin ${Target}.out ${Target}_firmware.out
	$(CG_TOOL_OBJCOPY) --remove-section=cert -O binary $(Target)_firmware.out $(Target).bin
	@echo 'Finished building bin file: $(Target).bin'
	@echo 'Creating certificate appended binary'
	$(PYTHON) $(C29SDK_ROOT)/tools/boot/signing/mcu_rom_image_gen.py $(ENC_SBL_OPTION) --image-bin $(Target).bin --core C29 --swrv 1 --loadaddr 0x10001000 --sign-key $(SIGNING_KEY) --out-image $(Target).cert.bin --device f29h85x --boot FLASH $(IMG_INTEG_CMD) $(DEBUG_COMMAND)
	$(CG_TOOL_OBJCOPY) --update-section cert=C29-cert-pad.bin $(Target)_firmware.out $(Target)_cert.out
	$(DELETE) $(Target).out C29-cert-pad.bin
	$(RENAME) $(Target)_cert.out $(Target).out
	@echo 'Finished building certificate appended binary: $(Target).cert.bin'
	@echo ' '

clean:
	-$(RM) $(Target).out
	-$(RM) $(Target)_firmware.out
	-$(RM) $(Target).map
	-$(RM) *.d
	-$(RM) *.bin
	-$(RM) $(OBJS_CLEAN)
	-$(RMDIR) syscfg
	-@echo 'Finished clean for $(Target)'
	-@echo ' '

# Custom x509 certificate signed target with local parameters
X509_PATH ?= $(C29SDK_ROOT)/tools/boot/signing
APPIMAGE_KEY_PATH ?= $(X509_PATH)/c29_custMpk.pem
ENC_KEY_PATH ?= $(X509_PATH)/c29_custMek.key
KD_SALT ?= $(X509_PATH)/kd_salt.txt
SWRV ?= 1
CORE ?= C29
LOADADDR ?= 0x0
ENC ?= y
DEBUG_FLAG ?=
DEBUG_OPTION ?=

image_signed: $(Target)_signed

$(Target)_signed: $(Target).out
	@echo 'Key Path: $(APPIMAGE_KEY_PATH)'
	@echo 'Encryption Key Path: $(ENC_KEY_PATH)'
	@echo 'KD Path: $(KD_SALT)'
	@echo 'Encryption: y'
	python $(X509_PATH)/c29_appimage_x509_cert_gen.py --bin $(Target).out --key $(APPIMAGE_KEY_PATH) --enc y --enckey $(ENC_KEY_PATH) --kd-salt $(KD_SALT) --output $(Target)_signed
	@echo 'Finished building target: $@'
	@echo ' '

rom_hsse: $(Target)_rom_hsse

$(Target)_rom_hsse: $(Target).out
	@echo 'Key Path: $(APPIMAGE_KEY_PATH)'
	@echo 'Encryption Key Path: $(ENC_KEY_PATH)'
	@echo 'KD Path: $(KD_SALT)'
	@echo 'Encryption: y'
	@echo 'Software Revision: $(SWRV)'
	@echo 'Core: $(CORE)'
	@echo 'SBL Run Address: $(LOADADDR)'
	python $(X509_PATH)/c29_rom_image_gen.py --sbl-enc --enc-key $(ENC_KEY_PATH) --image-bin $(Target).out --core $(CORE) --swrv $(SWRV) --loadaddr $(LOADADDR) --sign-key $(APPIMAGE_KEY_PATH) --kd-salt $(KD_SALT) --out-image $@ $(DEBUG_FLAG) $(DEBUG_OPTIONS)
	@echo 'Finished building target: $@'

rom_hsfs: $(Target)_rom_hsfs

$(Target)_rom_hsfs: $(Target).out
	@echo 'Key Path: $(APPIMAGE_KEY_PATH)'
	@echo 'Software Revision: $(SWRV)'
	@echo 'Core: $(CORE)'
	@echo 'SBL Run Address: $(LOADADDR)'
	python $(X509_PATH)/c29_rom_image_gen.py --image-bin $(Target).out --core $(CORE) --swrv $(SWRV) --loadaddr $(LOADADDR) --sign-key $(APPIMAGE_KEY_PATH) --out-image $@ $(DEBUG_FLAG) $(DEBUG_OPTIONS)
	@echo 'Finished building target: $@'